#!/usr/bin/env node

'use strict'

const { camelCase, reduce, mapKeys } = require('lodash')
const writeJsonFile = require('write-json-file')
const papa = require('papaparse')
const got = require('got')

// https://www.papaparse.com/docs#config
const PARSER_OPTS = {
  header: true,
  trimHeaders: true,
  dynamicTyping: true,
  skipEmptyLines: true
}

;(async () => {
  const { body } = await got('https://moz.com/top-500/download/?table=top500Domains')
  const { data } = papa.parse(body, PARSER_OPTS)
  const buffer = reduce(data, (acc, value) => {
    const newValue = mapKeys(value, (value, key) => camelCase(key))
    return [...acc, newValue]
  }, [])

  await writeJsonFile('top-sites.json', buffer)
})()
